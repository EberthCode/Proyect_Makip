<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/makip/PedidoViewModel.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/makip/PedidoViewModel.kt" />
              <option name="originalContent" value="package com.example.makip&#10;&#10;import android.app.Application&#10;import android.content.Context&#10;import android.content.Intent&#10;import android.net.Uri&#10;import android.widget.Toast&#10;import androidx.lifecycle.AndroidViewModel&#10;import androidx.lifecycle.viewModelScope&#10;import com.example.makip.data.Pedido&#10;import com.example.makip.data.PedidoRepository&#10;import kotlinx.coroutines.launch&#10;import java.net.URLEncoder&#10;&#10;class PedidoViewModel(application: Application) : AndroidViewModel(application) {&#10;&#10;    private val repository = PedidoRepository(application)&#10;&#10;    /**&#10;     * Crea un pedido y guarda las rutas de las fotos localmente.&#10;     * Inmediatamente intenta sincronizar con ImageKit si hay internet.&#10;     */&#10;    fun realizarPedido(&#10;        pedido: Pedido,&#10;        rutasLocales: List&lt;String&gt;,&#10;        onSuccess: (Long) -&gt; Unit,&#10;        onError: (String) -&gt; Unit&#10;    ) {&#10;        viewModelScope.launch {&#10;            try {&#10;                // 1. Guardar pedido y referencias locales (Offline First)&#10;                val pedidoId = repository.crearPedidoConReferencias(pedido, rutasLocales)&#10;                &#10;                // 2. Intentar subir fotos en segundo plano&#10;                // No bloqueamos el éxito del pedido si esto falla (se puede reintentar luego)&#10;                launch {&#10;                    try {&#10;                        repository.sincronizarFotosPendientes(pedidoId)&#10;                    } catch (e: Exception) {&#10;                        e.printStackTrace()&#10;                    }&#10;                }&#10;                &#10;                onSuccess(pedidoId)&#10;            } catch (e: Exception) {&#10;                onError(&quot;Error al guardar pedido: ${e.message}&quot;)&#10;            }&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Genera el mensaje de WhatsApp con los datos del pedido y las URLs de las fotos.&#10;     * Si las fotos aún no se han subido, mostrará un aviso de pendiente.&#10;     */&#10;    fun enviarPedidoWhatsApp(context: Context, pedidoId: Long) {&#10;        viewModelScope.launch {&#10;            val pedido = repository.obtenerPedido(pedidoId)&#10;            if (pedido == null) {&#10;                Toast.makeText(context, &quot;Pedido no encontrado&quot;, Toast.LENGTH_SHORT).show()&#10;                return@launch&#10;            }&#10;&#10;            // Reintentar sincronización antes de enviar si es necesario&#10;            repository.sincronizarFotosPendientes(pedidoId)&#10;            &#10;            val fotos = repository.obtenerFotosDePedido(pedidoId)&#10;            &#10;            val sb = StringBuilder()&#10;            sb.append(&quot;Hola Makip!  Quiero realizar el siguiente pedido:\n\n&quot;)&#10;            sb.append(&quot;*PEDIDO #${pedido.id}*\n&quot;)&#10;            sb.append(&quot;--------------------------------\n&quot;)&#10;            sb.append(&quot; Cliente: ${pedido.celularCliente}\n&quot;)&#10;            sb.append(&quot; Producto ID: ${pedido.productoId}\n&quot;) // Podrías hacer un join para sacar el nombre&#10;            sb.append(&quot; Cantidad: ${pedido.cantidad}\n&quot;)&#10;            sb.append(&quot; Detalle: ${pedido.colorOTalla}\n&quot;)&#10;            if (!pedido.textoPersonalizado.isNullOrEmpty()) {&#10;                sb.append(&quot;✍️ Texto: ${pedido.textoPersonalizado}\n&quot;)&#10;            }&#10;            sb.append(&quot; Pago: ${pedido.metodoPago}\n&quot;)&#10;            sb.append(&quot; Dirección: ${pedido.direccionEntrega}, ${pedido.distrito}\n\n&quot;)&#10;            &#10;            sb.append(&quot;*FOTOS DE REFERENCIA:*\n&quot;)&#10;            if (fotos.isEmpty()) {&#10;                sb.append(&quot;(Sin fotos de referencia)\n&quot;)&#10;            } else {&#10;                fotos.forEachIndexed { index, foto -&gt;&#10;                    if (foto.sincronizada) {&#10;                        sb.append(&quot;${index + 1}. ${foto.urlFoto}\n&quot;)&#10;                    } else {&#10;                        sb.append(&quot;${index + 1}. [Subiendo foto...] (Aún no sincronizada)\n&quot;)&#10;                    }&#10;                }&#10;            }&#10;&#10;            val mensaje = sb.toString()&#10;            val numeroTelefono = &quot;51981390836&quot; // Número de WhatsApp de Makip&#10;&#10;            try {&#10;                val url = &quot;https://api.whatsapp.com/send?phone=$numeroTelefono&amp;text=${URLEncoder.encode(mensaje, &quot;UTF-8&quot;)}&quot;&#10;                val intent = Intent(Intent.ACTION_VIEW).apply {&#10;                    data = Uri.parse(url)&#10;                    flags = Intent.FLAG_ACTIVITY_NEW_TASK&#10;                }&#10;                context.startActivity(intent)&#10;            } catch (e: Exception) {&#10;                Toast.makeText(context, &quot;No se pudo abrir WhatsApp&quot;, Toast.LENGTH_SHORT).show()&#10;            }&#10;        }&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.makip&#13;&#10;&#13;&#10;import android.app.Application&#13;&#10;import android.content.Context&#13;&#10;import android.content.Intent&#13;&#10;import android.net.Uri&#13;&#10;import android.widget.Toast&#13;&#10;import androidx.lifecycle.AndroidViewModel&#13;&#10;import androidx.lifecycle.viewModelScope&#13;&#10;import com.example.makip.data.Pedido&#13;&#10;import com.example.makip.data.PedidoRepository&#13;&#10;import kotlinx.coroutines.launch&#13;&#10;import java.net.URLEncoder&#13;&#10;&#13;&#10;class PedidoViewModel(application: Application) : AndroidViewModel(application) {&#13;&#10;&#13;&#10;    private val repository = PedidoRepository(application)&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Crea un pedido y guarda las rutas de las fotos localmente.&#13;&#10;     * Inmediatamente intenta sincronizar con ImageKit si hay internet.&#13;&#10;     */&#13;&#10;    fun realizarPedido(&#13;&#10;        pedido: Pedido,&#13;&#10;        rutasLocales: List&lt;String&gt;,&#13;&#10;        onSuccess: (Long) -&gt; Unit,&#13;&#10;        onError: (String) -&gt; Unit&#13;&#10;    ) {&#13;&#10;        viewModelScope.launch {&#13;&#10;            try {&#13;&#10;                // 1. Guardar pedido y referencias locales (Offline First)&#13;&#10;                val pedidoId = repository.crearPedidoConReferencias(pedido, rutasLocales)&#13;&#10;                &#13;&#10;                // 2. Intentar subir fotos en segundo plano&#13;&#10;                // No bloqueamos el éxito del pedido si esto falla (se puede reintentar luego)&#13;&#10;                launch {&#13;&#10;                    try {&#13;&#10;                        repository.sincronizarFotosPendientes(pedidoId)&#13;&#10;                    } catch (e: Exception) {&#13;&#10;                        e.printStackTrace()&#13;&#10;                    }&#13;&#10;                }&#13;&#10;                &#13;&#10;                onSuccess(pedidoId)&#13;&#10;            } catch (e: Exception) {&#13;&#10;                onError(&quot;Error al guardar pedido: ${e.message}&quot;)&#13;&#10;            }&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Genera el mensaje de WhatsApp con los datos del pedido y las URLs de las fotos.&#13;&#10;     * Si las fotos aún no se han subido, mostrará un aviso de pendiente.&#13;&#10;     */&#13;&#10;    fun enviarPedidoWhatsApp(context: Context, pedidoId: Long) {&#13;&#10;        viewModelScope.launch {&#13;&#10;            val pedido = repository.obtenerPedido(pedidoId)&#13;&#10;            if (pedido == null) {&#13;&#10;                Toast.makeText(context, &quot;Pedido no encontrado&quot;, Toast.LENGTH_SHORT).show()&#13;&#10;                return@launch&#13;&#10;            }&#13;&#10;&#13;&#10;            // Reintentar sincronización antes de enviar si es necesario&#13;&#10;            repository.sincronizarFotosPendientes(pedidoId)&#13;&#10;            &#13;&#10;            val fotos = repository.obtenerFotosDePedido(pedidoId)&#13;&#10;            &#13;&#10;            val sb = StringBuilder()&#13;&#10;            sb.append(&quot;Hola Makip!  Quiero realizar el siguiente pedido:\n\n&quot;)&#13;&#10;            sb.append(&quot;*PEDIDO #${pedido.id}*\n&quot;)&#13;&#10;            sb.append(&quot;--------------------------------\n&quot;)&#13;&#10;            sb.append(&quot; Cliente: ${pedido.celularCliente}\n&quot;)&#13;&#10;            sb.append(&quot; Producto ID: ${pedido.productoId}\n&quot;) // Podrías hacer un join para sacar el nombre&#13;&#10;            sb.append(&quot; Cantidad: ${pedido.cantidad}\n&quot;)&#13;&#10;            sb.append(&quot; Detalle: ${pedido.colorOTalla}\n&quot;)&#13;&#10;            if (!pedido.textoPersonalizado.isNullOrEmpty()) {&#13;&#10;                sb.append(&quot;✍️ Texto: ${pedido.textoPersonalizado}\n&quot;)&#13;&#10;            }&#13;&#10;            sb.append(&quot; Pago: ${pedido.metodoPago}\n&quot;)&#13;&#10;            sb.append(&quot; Dirección: ${pedido.direccionEntrega}, ${pedido.distrito}\n\n&quot;)&#13;&#10;            &#13;&#10;            sb.append(&quot;*FOTOS DE REFERENCIA:*\n&quot;)&#13;&#10;            if (fotos.isEmpty()) {&#13;&#10;                sb.append(&quot;(Sin fotos de referencia)\n&quot;)&#13;&#10;            } else {&#13;&#10;                fotos.forEachIndexed { index, foto -&gt;&#13;&#10;                    if (foto.sincronizada) {&#13;&#10;                        sb.append(&quot;${index + 1}. ${foto.urlFoto}\n&quot;)&#13;&#10;                    } else {&#13;&#10;                        sb.append(&quot;${index + 1}. [Subiendo foto...] (Aún no sincronizada)\n&quot;)&#13;&#10;                    }&#13;&#10;                }&#13;&#10;            }&#13;&#10;&#13;&#10;            val mensaje = sb.toString()&#10;            val numeroTelefono = &quot;51981390836&quot; // Número de WhatsApp de Makip&#13;&#10;&#13;&#10;            try {&#13;&#10;                val url = &quot;https://api.whatsapp.com/send?phone=$numeroTelefono&amp;text=${URLEncoder.encode(mensaje, &quot;UTF-8&quot;)}&quot;&#13;&#10;                val intent = Intent(Intent.ACTION_VIEW).apply {&#13;&#10;                    data = Uri.parse(url)&#13;&#10;                    flags = Intent.FLAG_ACTIVITY_NEW_TASK&#13;&#10;                }&#13;&#10;                context.startActivity(intent)&#13;&#10;            } catch (e: Exception) {&#13;&#10;                Toast.makeText(context, &quot;No se pudo abrir WhatsApp&quot;, Toast.LENGTH_SHORT).show()&#13;&#10;            }&#13;&#10;        }&#13;&#10;    }&#13;&#10;}&#13;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>